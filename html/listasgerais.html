<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Opera√ß√µes</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    
       <!-- > css/listasgerais* -->
  
</head>
<body>

    <!-- Painel de Filtros e Campos de Texto 
    <div class="painel-container">
        <h2>Painel de Filtros e Opera√ß√µes</h2>-->

          <div class="painel-header">
            <div class="header">
            <h1> Painel de Filtros e Opera√ß√µes </h1>
            </div>
              </div>
    

        <!-- Filtro Cestas -->
         <div class="painel-container">
        <div class="form-group">
            <label for="listaCestaVerde">Tipo de Cesta:</label>
            <select id="listaCestaVerde" name="CestaVerde">
                <option value="Cesta B√°sica">Cesta B√°sica</option>
                <option value="Cesta Verde">Cesta Verde</option>
                <option value="Cesta B√°sica + Verde">Cesta B√°sica + Verde</option>
            </select>
        </div>

        <!-- Campo de Data -->
        <div class="form-group">
            <label for="dataEntrega">Data de Entrega:</label>
            <input type="date" id="dataEntrega" name="dataEntrega">
        </div>

        <!-- Input Texto para Editar o T√≠tulo -->
        <div class="form-group">
            <label for="tituloRecibo">Editar T√≠tulo do Recibo:</label>
            <input type="text" id="tituloRecibo" value="Recibo de Entrega das Cestas Verde, contrapartida do Projeto 'Algazarra Coral: forma√ß√£o vocal e responsabilidade social - ano 2024'">
        </div>

        <!-- Input Texto para Editar a Lei de Incentivo -->
        <div class="form-group">
            <label for="leiIncentivo">Editar Lei de Incentivo:</label>
            <input type="text" id="leiIncentivo" value="Lei de Incentivo √† Cultura Capixaba (LICC)">
        </div>

        <!-- Checkboxes Situa√ß√£o e Tipo Coral -->
        <div class="checkbox-group-container">
            <div class="checkbox-group">
                <label>Situa√ß√£o:</label><br>
                <input type="checkbox" id="ativo" name="situacao" checked>
                <label for="ativo">Ativo</label>
                <input type="checkbox" id="desistente" name="situacao">
                <label for="desistente">Desistente</label>
            </div>

            <div class="checkbox-group">
                <label>Tipo Coral:</label><br>
                <input type="checkbox" id="coralAlgazarra" name="tipoCoral" checked>
                <label for="coralAlgazarra">Coral Algazarra</label>
            </div>
        </div>

        <!-- Bot√£o para abrir o modal -->
        <button class="btn open-modal-btn">Abrir Recibo</button>
    </div>

    <!-- O Modal -->
    <div id="reciboModal" class="modal">

        <div class="modal-content">
                <span class="close">&times;</span>
                <span class="print-icon" onclick="printRecibo()" style="cursor: pointer; float: right; font-size: 24px; margin-right: 10px;">üñ®Ô∏è</span> <!-- √çcone de impress√£o -->

                <!-- Layout do recibo -->
                <div class="recibo-container">
                    <table class="recibo-header-table">
                    <tr>
                        <td class="recibo-header-left">
                            <img src="https://i.ibb.co/Y768JNk/algazarra.jpg" alt="Algazarra Logo" width="120">
                        </td>
                        <td class="recibo-header-center">
                            CNPJ 11.510.597/0001-30 <br>
                            Pra√ßa Costa Pereira n¬∫ 52 - Edif√≠cio Michelini - sala 1104, <br>
                            Centro de Vit√≥ria.
                        </td>
                        <td class="recibo-header-right">
                            <img src="https://i.ibb.co/6w8N1kp/instituto-Todos-Cantos.jpg" alt="Instituto Todos os Cantos Logo" width="120">
                        </td>
                    </tr>
                </table>

                <table class="recibo-header-table">
                    <tr>
                        <td colspan="3" class="title" id="reciboTitle">Recibo de Entrega das Cestas Verde, contrapartida do Projeto "Algazarra Coral: forma√ß√£o vocal e responsabilidade social - ano 2024"</td>
                    </tr>
                </table>

                <table class="recibo-header-table details-row">
                    <tr>
                        <td><span class="label">Data da entrega:</span><span id="reciboData">____/____/______</span></td>
                        <td><span class="label">M√™s de refer√™ncia:</span><span id="mesReferencia">__________________</span></td>
                        <td><span class="label" id="reciboLei">Lei de Incentivo √† Cultura Capixaba (LICC)</span></td>
                    </tr>
                </table>

                <table class="recibo-table">
                    <thead>
                        <tr>
                            <th style="width: 5%;">N¬∫</th>
                            <th style="width: 40%;">NOME DO BENEFICI√ÅRIO</th>
                            <th style="width: 35%;">ASSINATURA DO RESPONS√ÅVEL</th>
                            <th style="width: 20%;">CPF DO RESPONS√ÅVEL</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1</td>
                            <td></td>
                            <td></td>
                            <td></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Seleciona o modal
        var modal = document.getElementById("reciboModal");

        // Bot√£o que abre o modal
        var btn = document.querySelector(".open-modal-btn");

        // Bot√£o que fecha o modal
        var span = document.querySelector(".close");

        // Fun√ß√£o para preencher a tabela dos benefici√°rios no modal
        function preencherTabelaBeneficiarios(dados) {
            console.log("Iniciando o preenchimento da tabela dos benefici√°rios...");
            
            var tabelaBody = document.querySelector(".recibo-table tbody");
            tabelaBody.innerHTML = ""; // Limpa a tabela antes de preencher com novos dados

            // Verifica se h√° dados a serem exibidos
            if (dados.length === 0) {
                console.log("Nenhum benefici√°rio encontrado para os filtros aplicados.");
                var mensagem = document.createElement("tr");
                var colunaMensagem = document.createElement("td");
                colunaMensagem.colSpan = 4; // Abrange todas as colunas da tabela
                colunaMensagem.textContent = "N√£o h√° alunos para o filtro informado.";
                colunaMensagem.style.textAlign = "center";
                mensagem.appendChild(colunaMensagem);
                tabelaBody.appendChild(mensagem);
            } else {
                console.log("N√∫mero de benefici√°rios encontrados: " + dados.length);
                // Popula a tabela com os dados recebidos do servidor
                dados.forEach(function(beneficiario, index) {
                    console.log("Preenchendo benefici√°rio: " + beneficiario.nome);
                    var linha = document.createElement("tr");

                    var colunaNum = document.createElement("td");
                    colunaNum.textContent = index + 1; // Define a ordem dos benefici√°rios
                    linha.appendChild(colunaNum);

                    var colunaNome = document.createElement("td");
                    colunaNome.textContent = beneficiario.nome; // Nome do benefici√°rio
                    linha.appendChild(colunaNome);

                    var colunaAssinatura = document.createElement("td");
                    colunaAssinatura.textContent = ""; // Deixa assinatura vazia para preenchimento
                    linha.appendChild(colunaAssinatura);

                    var colunaCpf = document.createElement("td");
                    colunaCpf.textContent = ""; // CPF pode ser deixado em branco ou preenchido posteriormente
                    linha.appendChild(colunaCpf);

                    tabelaBody.appendChild(linha);
                });
            }
        }

        // Fun√ß√£o para buscar os dados dos benefici√°rios com base nos filtros selecionados
        function buscarDadosBeneficiarios() {
            console.log("Iniciando a busca de benefici√°rios...");
            
            var ativo = document.getElementById("ativo").checked;
            var desistente = document.getElementById("desistente").checked;
            var coralAlgazarra = document.getElementById("coralAlgazarra").checked;
            var listaCestaVerde = document.getElementById("listaCestaVerde").value;

            // Mapeamento dos valores de "Tipo de Cesta"
            var tipoCestaMap = {
                "Cesta B√°sica": "cestaBasica",
                "Cesta Verde": "cestaVerde",
                "Cesta B√°sica + Verde": "cestaBasicaVerde"
            };

            var tipoCesta = tipoCestaMap[listaCestaVerde] || "";

            // Mostra os filtros aplicados no console
            console.log("Filtros - Ativo: " + ativo + ", Desistente: " + desistente + ", Coral Algazarra: " + coralAlgazarra + ", Tipo de Cesta: " + tipoCesta);

            // Corrigindo a ordem de encadeamento
            google.script.run
                .withSuccessHandler(preencherTabelaBeneficiarios)
                .withFailureHandler(function(error) {
                    console.error("Erro ao buscar benefici√°rios: " + error.message);
                })
                .buscarBeneficiariosFiltrados(ativo, desistente, coralAlgazarra, tipoCesta);
        }

        // Fun√ß√£o para obter o nome do m√™s em portugu√™s
        function obterMesPtBr(mes) {
            const meses = ["janeiro", "fevereiro", "mar√ßo", "abril", "maio", "junho", "julho", "agosto", "setembro", "outubro", "novembro", "dezembro"];
            return meses[mes];
        }

        // Fun√ß√£o para atualizar o conte√∫do do modal com os inputs
        function atualizarModal() {
            var listaCestaVerde = document.getElementById("listaCestaVerde").value;
            var tituloRecibo = `Recibo de Entrega das ${listaCestaVerde}, contrapartida do Projeto 'Algazarra Coral: forma√ß√£o vocal e responsabilidade social - ano ${new Date().getFullYear()}'`;
            var leiIncentivo = document.getElementById("leiIncentivo").value;
            var dataEntrega = document.getElementById("dataEntrega").value;

            document.getElementById("tituloRecibo").value = tituloRecibo;
            document.getElementById("reciboTitle").innerText = tituloRecibo;
            document.getElementById("reciboLei").innerText = leiIncentivo;

            if (dataEntrega) {
                var data = new Date(dataEntrega);
                var mesReferencia = `${obterMesPtBr(data.getMonth())}/${data.getFullYear()}`;
                document.getElementById("reciboData").innerText = dataEntrega.split('-').reverse().join('/');
                document.getElementById("mesReferencia").innerText = mesReferencia;
            }
        }

        // Quando o usu√°rio clicar no bot√£o, abre o modal e atualiza com os dados
        btn.onclick = function() {
            console.log("Bot√£o de abrir modal clicado.");
            atualizarModal(); // Atualiza outros campos do modal
            buscarDadosBeneficiarios(); // Faz a requisi√ß√£o dos benefici√°rios filtrados
            modal.style.display = "block"; // Exibe o modal

            // Definir a fun√ß√£o printRecibo dentro do escopo de abertura do modal
            function printRecibo() {
                console.log("Iniciando a impress√£o do recibo...");

                // Seleciona o conte√∫do que voc√™ quer imprimir
                var reciboContent = document.querySelector('.recibo-container').innerHTML;

                // Abre uma nova janela (ou aba) para a impress√£o
                var printWindow = window.open('', '', 'width=800,height=600');

                // Define o conte√∫do da nova janela (somente o conte√∫do do recibo)
                printWindow.document.write(`
                    <html>
                    <head>
                        <title>Impress√£o do Recibo</title>
                        <style>
                            body {
                                font-family: 'Roboto', sans-serif;
                            }
                            .recibo-table {
                                width: 100%;
                                border-collapse: collapse;
                                margin-top: 10px;
                            }
                            .recibo-table th, .recibo-table td {
                                border: 1px solid black;
                                padding: 5px;
                                text-align: left;
                            }
                            .recibo-header-table {
                                width: 100%;
                                border-collapse: collapse;
                                border: 1px solid black;
                            }
                            .recibo-header-table td {
                                padding: 5px;
                                text-align: center;
                                vertical-align: middle;
                                font-size: 10px;
                                border: 1px solid black;
                            }
                            .title {
                                font-size: 14px;
                                font-weight: bold;
                                text-align: center;
                            }
                            .details-row td {
                                font-size: 10px;
                                border: 1px solid black;
                            }
                            @media print {
                                @page {
                                    size: A4;
                                    margin: 3cm 2cm 2cm 3cm; /* Margens da p√°gina */
                                }
                            }
                        </style>
                    </head>
                    <body>
                        ${reciboContent} <!-- Conte√∫do do recibo -->
                    </body>
                    </html>
                `);

                // Espera o conte√∫do ser carregado e depois imprime
                printWindow.document.close(); // Necess√°rio para terminar a escrita
                printWindow.focus(); // Garante que a janela esteja em foco
                printWindow.print(); // Chama a impress√£o da nova janela
                printWindow.close(); // Fecha a janela ap√≥s a impress√£o

                console.log("Impress√£o conclu√≠da.");
            }

            // Agora, a fun√ß√£o printRecibo estar√° dispon√≠vel para o √≠cone de impress√£o
            document.querySelector('.print-icon').onclick = printRecibo;
        }

        // Quando o usu√°rio clicar no "x", fecha o modal
        span.onclick = function() {
            console.log("Bot√£o para fechar modal clicado.");
            modal.style.display = "none";
        }

        // Quando o usu√°rio clicar fora do modal, fecha o modal
        window.onclick = function(event) {
            if (event.target == modal) {
                console.log("Modal fechado ao clicar fora dele.");
                modal.style.display = "none";
            }
        }
    </script>

</body>
</html>
